{
  "name": "TP NFC",
  "tagline": "TP NFC en Android",
  "body": "# TP NFC\r\n\r\n## Introduction\r\n### Qu’est ce que le NFC ?\r\nLe NFC, ou Near Fields Communication (Communication en champ rapproché) est une technologie de communication sans fil à courte portée et à haute fréquence, permettant l'échange d'informations entre des périphériques jusqu'à une distance d'environ 10 cm.\r\nC’est une forme de RFID (Radio Frequency IDentification), cependant la distance d’échange de données est bien moins importantes que la plupart des autres dispositifs RFID, qui est de 2m à 10m généralement.\r\n\r\n\r\nOn distingue trois types de fonctionnement des équipements NFC (Ou étiquettes/tags) : \r\n- Le mode émulation de carte\r\n- Le mode lecteur\r\n- Le mode Peer-to-Peer\r\nEn mode émulation de carte, le device NFC est dit “passif” : il se comporte comme une carte à puce sans contact et est donc cible des autres devices NFC.\r\nEn mode lecteur, le device NFC émet un champ magnétique pour initier la communication avec un tag NFC et lui envoie une commande. C’est un fonctionnement de lecteur de carte et le device est dit “actif” car il envoie des informations.\r\nEn mode Peer-to-Peer les deux devices NFC prennent tours à tours le rôle “émulateur de carte” et “lecteur”, ils communiquent entre eux et s’échange des informations. C’est l’utilisation que nous pouvons avoir en échangeant des coordonnées GPS par Google Maps par exemple, en collant dos à dos les smartphones.\r\n\r\n\r\n### Mais à quoi ça sert concrètement ?\r\nLe NFC permet d’échanger des données entre deux appareils équipés.\r\nLes utilisations les plus répandues sont :\r\nPaiement : Le paiement sans contact des cartes bancaires ou étudiantes (IZLI et l’ancienne également)\r\nPasse/identification : Ouvrir des portes, ...\r\nÉchange de données : Échanger des contacts deux smartphones dos à dos\r\n…\r\n\r\n\r\nSur un appareil android il existe des applications dédiés pour lire/écrire sur un tag NFC, définir des actions à la suite de la lecture d’un tag NFC, …\r\nSur des applications comme Google Maps, nous pouvons échanger les coordonnées marqués d’un device à un autre.\r\n\r\n## Objectifs du TP\r\nL’objectif de ce TP est de se familiariser avec l’utilisation du NFC sur Android.\r\nNous verrons comment activer le NFC (si l’appareil le permet) et comment recevoir des intents au contact d’un tag NFC (nous utiliserons la carte étudiants ;) ).\r\nDéroulement du TP\r\n\r\n### Initialisation du projet\r\nOn va tout d’abord créer un projet sous Android Studio en sélectionnant l’API 10 minimum visant Android 2.3.3 puis en choisissant “Empty Activity”.\r\nCommençons par paramétrer notre application pour manipuler le NFC.\r\nDans AndroidManifest.xml, ajoutez ces lignes :\r\n\r\n```xml\r\n<uses-permission android:name=\"android.permission.NFC\"/>\r\n<uses-feature android:name=\"android.hardware.nfc\"\r\n   android:required=\"false\"/>\r\n```\r\n\r\nCes lignes permettent de demander l’utilisation du NFC s’il est disponible sur l’appareil et interdisent l’affichage dans le playstore de notre application aux devices n’étant pas équipé du NFC.\r\n\r\n### Vérification de la compatibilité et de l’activation du NFC\r\n\r\n\r\nDirection MainActivity.java. Le but va être maintenant de vérifier si l’appareil possède le NFC et s’il le possède, savoir s’il est activé. Pour cela nous allons copier ces lignes dans le onCreate :\r\n\r\n```java\r\nnfcAdapter = NfcAdapter.getDefaultAdapter(this);\r\ntextView = (TextView) findViewById(R.id.textView);\r\n```\r\n\r\n```java\r\n// Vérifie si l'appareil a le NFC activé et s'il est activé\r\nif(nfcAdapter == null){\r\n   Toast.makeText(this, \"NFC n'est pas disponible :'(\", Toast.LENGTH_LONG).show();\r\n}else if(nfcAdapter.isEnabled()){\r\n   Toast.makeText(this, \"NFC activé\", Toast.LENGTH_LONG).show();\r\n}else{\r\n   Toast.makeText(this, \"NFC non activé\", Toast.LENGTH_LONG).show();\r\n}\r\n```\r\n\r\nSur le code ci-dessus, on vérifie dans le premier if si notre nfcAdapter est égal à null, auquel cas celà voudrait dire que notre appareil ne prend pas en charge NFC.\r\nEnsuite le else if est pour le cas ou le nfcAdapter est différent de null et est activé. Enfin le else pour le cas ou le NFC n’est pas activé.\r\n\r\n\r\nRien ne vous échappe … Effectivement, nous n’avons pas instancié notre variable nfcAdapter. Nous plaçons donc la ligne ci-dessous au dessus de la méthode onCreate, toujours dans notre MainActivity.java. Nous parlerons par la suite de la variable textView.\r\n\r\n```java\r\nNfcAdapter nfcAdapter;\r\nTextView textView;\r\n```\r\n\r\n### Réception d’un intent NFC\r\n\r\n\r\nA partir d’ici, vous pouvez d’ores et déjà tester l’application pour savoir si votre appareil est compatible NFC. Maintenant que notre objet NFC est initialisé et que nous sommes au courant de la compatibilité et de la mise en marche de notre NFC, nous pouvons maintenant être signalé lors d’un contact avec un tag NFC.\r\n\r\n\r\nPour cela nous allons écrire trois méthodes :\r\n- onResume\r\n- onPause\r\n- onNewIntent\r\n\r\n\r\nCopiez-collez ce code correspondant à la méthode onResume (toujours dans MainActivity.java) :\r\n\r\n```java\r\n@Override\r\nprotected void onResume() {\r\n   Intent intent = new Intent(this, MainActivity.class);\r\n   intent.addFlags(Intent.FLAG_RECEIVER_REPLACE_PENDING);\r\n\r\n   PendingIntent pendingIntent = PendingIntent.getActivity(this, 0, intent, 0);\r\n   IntentFilter[] intentFilter = new IntentFilter[]{};\r\n\r\n   if(nfcAdapter != null) {\r\n       nfcAdapter.enableForegroundDispatch(this, pendingIntent, intentFilter, null);\r\n   }\r\n\r\n   super.onResume();\r\n}\r\n```\r\n\r\n\r\nDans le code ci-dessus nous créons l’intent et ensuite nous vérifions que le NFC est disponible sur l’appareil pour utiliser la méthode enableForegroundDispatch pour activer la réceptions de tags NFC pour l’activity en question.\r\n\r\n\r\nEnsuite copiez ce code à la suite du précédent :\r\n\r\n```java\r\n@Override\r\nprotected void onPause() {\r\n   if(nfcAdapter != null) {\r\n       nfcAdapter.disableForegroundDispatch(this);\r\n   }\r\n\r\n   super.onPause();\r\n}\r\n```\r\n\r\nCe code contenant la méthode contraire à enableForegroundDispatch désactive la reception de tag NFC pour cette activity.\r\n\r\n\r\nEnfin, la méthode gérant l’action à la suite de la réception d’un intent d’un tag NFC :\r\n\r\n```java\r\n@Override\r\nprotected void onNewIntent(Intent intent) {\r\n   // Permet de notifier la reconnaissance d'un TAG NFC\r\n   Toast.makeText(this, \"NFC intent reçu!\", Toast.LENGTH_LONG).show();\r\n\r\ntextView = (TextView) findViewById(R.id.textView);\r\ntextView.setText(textView.getText() + \"\\n\" + formatTimeToFrance());\r\n\r\n   super.onNewIntent(intent);\r\n}\r\n```\r\n\r\nDans ce code, nous envoyons tout simplement un toast à l’activity, et nous affichons dans le textView (le fameux textView du début) l’heure à laquelle nous avons reçu l’intent grâce à une fonction que nous allons implémenté juste après notre textView. \r\n\r\n\r\nNous allons donc rajouter notre textView. Direction activity_main.xml :\r\n\r\n```xml\r\n<TextView\r\n   android:layout_width=\"wrap_content\"\r\n   android:layout_height=\"wrap_content\"\r\n   android:layout_alignParentTop=\"true\"\r\n   android:layout_alignParentLeft=\"true\"\r\n   android:layout_alignParentStart=\"true\"\r\n   android:id=\"@+id/textView\"\r\n   android:layout_alignParentRight=\"true\"\r\n   android:layout_alignParentEnd=\"true\"\r\n   android:layout_alignParentBottom=\"true\"\r\n   android:text=\"Intent reçus: \" />\r\n```\r\n\r\nIl nous faut donc maintenant la magnifique fonction formatTimeToFrance :\r\n(Il existe des méthodes plus “sympa” pour formater une date mais elle nécessitent des API plus élevés. Pour l’usage du TP, cette fonction fera l’affaire :) ).\r\n\r\n```java\r\n// Cocorico\r\nprotected String formatTimeToFrance() {\r\n   long millis = System.currentTimeMillis();\r\n   return String.format(\"%02d:%02d:%02d\", (TimeUnit.MILLISECONDS.toHours(millis) % 24) + 1,\r\n           TimeUnit.MILLISECONDS.toMinutes(millis) - TimeUnit.HOURS.toMinutes(TimeUnit.MILLISECONDS.toHours(millis)),\r\n           TimeUnit.MILLISECONDS.toSeconds(millis) - TimeUnit.MINUTES.toSeconds(TimeUnit.MILLISECONDS.toMinutes(millis)));\r\n}\r\n```\r\n\r\n\r\nVous pouvez tester à nouveau l’application (si vous disposez du NFC c’est plus intéressant) et passer votre carte étudiant (ou carte bancaire, passeport; …) derrière votre appareil Android. Vous constaterez un joli toast qui spécifie que votre appareil reconnaît la carte comme un tag NFC et vous avez un historique des intents.\r\n\r\n## Fin du TP\r\nMerci de votre attention, j'espère que ce TP vous aura plu et que vous aurez appris des choses.\r\nPour conclure je dirais que le NFC n’est pas encore très répandu et connu des utilisateurs, même ceux qui disposent du NFC mais les possibilités sont nombreuses. \r\nCette technologie peut faciliter le transfert de petites informations et donne accès à de nouveaux moyens de partage rapides.\r\nPour plus de renseignements je vous invite à consulter la doc Android Developpers sur le sujet du NFC : https://developer.android.com/guide/topics/connectivity/nfc/nfc.html\r\nVoici la liste des téléphones compatibles NFC : http://www.nfcworld.com/nfc-phones-list/",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}